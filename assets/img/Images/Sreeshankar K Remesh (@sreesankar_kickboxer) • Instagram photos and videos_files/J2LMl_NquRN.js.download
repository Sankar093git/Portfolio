;/*FB_PKG_DELIM*/

__d("LSRestoreProtobufs.nop",["CurrentUser","I64","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEBUploadMessageUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","Promise","WAJids","WATagsLogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - ",""]);m=function(){return a};return a}a=function(a,e,f,g,i,p,q,r,s,t,u,v,w,x){a=null;w!=null&&(a=n(w));d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(e=t)!=null?e:"no_request_id"]).LOG(m(),(w=t)!=null?w:"no_request_id");d("MAWEBRestoreTrackingUtils").markEBRestoreProtobuf(x);e=o(g);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(e,"protobuf_restore");if(t!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:t,type:"protobuf"});var y=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());w=d("MAWHandleEchoProtobufsRestoreApi").decodeProtobufArray(e,y,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0).map(function(a){var b;if((a==null?void 0:(b=a.metadata)==null?void 0:b.messageId)!=null){b=d("MAWHandleEchoProtobufsRestoreApi").createUnstoredDbContentFromProtobufObject(a,d("WAJids").unsafeCoerceToChatJid(f),y,new Map(),void 0);if(b!=null&&b.unstoredDbContent.unstoredDbMsg!=null){a=b.unstoredDbContent.unstoredDbMsg;b=d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(a);a.sortOrderMs=b;return a}return null}return null}).filter(Boolean);d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(t,{echoMessages:a,hasMoreAfter:q,hasMoreBefore:i,isPointQuery:s,messages:w,nextMessageTimestampMsBefore:p,protobufMessages:e,referenceTimestamp:u,requestId:t,restoreType:"protobuf",threadId:f})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(g=t)!=null?g:"no_request_id"]).ERROR(l(),a.message)}w=x!=null&&(j||(j=d("LSIntEnum"))).unwrapIntEnum(x)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(w)return(h||(h=b("Promise"))).resolve();g=x!=null&&(j||(j=d("LSIntEnum"))).unwrapIntEnum(x)===c("LSMEBTaskCreationSource").MSGR_DYI;if(g){d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore",(w=t)!=null?w:"no_request_id"]).LOG(k());void d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(f,e,i,p);return(h||(h=b("Promise"))).resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(f),e,i,p,q,r,s,t,u,v,a,x));return(h||(h=b("Promise"))).resolve()};function n(a){return c("LSVec").toArray(a).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)})}function o(a){a=c("LSVec").toArray(a);a=a.map(function(a){return d("LSShape").toRecord(a)});return a.map(function(a){var b=d("LSShape").toRecord(a.toplevel_protobuf);b={decryptedProtobuf:b.decrypted_protobuf,protobufTimestampMS:(i||(i=d("I64"))).to_float(b.protobuf_timestamp_ms)};var c=new Map(),e=a.supplemental_protobufs;e.forEach(function(a,b){a=d("LSShape").toRecord(a);c.set(b,{decryptedProtobuf:a.decrypted_protobuf,protobufTimestampMS:(i||(i=d("I64"))).to_float(a.protobuf_timestamp_ms)})});return{otid:a.otid,supplementalProtobufs:c,toplevelProtobuf:b}})}g["default"]=a}),98);