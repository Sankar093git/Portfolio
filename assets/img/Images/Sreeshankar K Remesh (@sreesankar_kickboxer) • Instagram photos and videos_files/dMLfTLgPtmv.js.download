;/*FB_PKG_DELIM*/

__d("EncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYISingleton","I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Issuing next range query for thread with thread key ",", server generated next reference timestamp: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["nextTimestampMs was not supplied for thread with thread key ","."]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handling message range query for thread with thread key ",", hasMoreBefore: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread key for thread id: ",""]);l=function(){return a};return a}function a(a,b,c,e,f,g,n){var o=d("EncryptedBackupsDYISingleton").getSingleton(),p=o.getLogger();o=o.getThreadKeyForThreadId(b);if(o==null){p.WARN(l(),b);return}void p.LOG(k(),b,e);c.length>0&&g(o,b,c);if(!e||f==null){e&&f==null&&void p.ERROR(j(),b);m(o);return}g=(h||(h=d("I64"))).to_string(f);void p.LOG(i(),b,g);void n(a,g,b)}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton();b.deleteThreadKeyFromThreadsRestoreInProgress(a)}g.handleMessageRangeQueryRestore=a}),98);
__d("EncryptedBackupsDYIMediaDownloadHandlers",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYISingleton","FBLogger","Promise","WAResultOrError","asyncToGeneratorRuntime","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){f=(yield d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle());b=b.split("/")[1];b=c("uuidv4")()+"."+b;yield d("EncryptedBackupsDYIFileUtils").writeFile(f,b,e);f=d("EncryptedBackupsDYISingleton").getSingleton();f.setMediaUrlByPlainTextHash(a,d("EncryptedBackupsDYIFileUtils").DyiMediaFolder+"/"+b);f.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return d("WAResultOrError").makeResult()});return function(b,c,d,e){return a.apply(this,arguments)}}();e=function(){c("FBLogger")("labyrinth_web").debug("[DYIMediaPreviewHandler] Skipping previews for DYI");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())};g.DYIMediaDownloadHandler=a;g.DYIMediaPreviewHandler=e}),98);
__d("MAWMIMediaDownloader",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSIssueAttachmentRestoreTaskStoredProcedure","LSMEBTaskCreationSource","MAWCastToMsgrServerMediaType","MAWThreadKeyUtils","MebMIMediaDownloader","MediaDownloadMediator","WAMediaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;a=function(a){babelHelpers.inheritsLoose(e,a);function e(){return a.apply(this,arguments)||this}var g=e.prototype;g.handle=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton);d("MediaDownloadMediator").mapDeliveryObjectIdToMediaDownloader(d("WAMediaUtils").stringToDeliveryObjectId(this.mediaDownloadMetadata.deliveryObjectId),this);var e=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(this.mediaDownloadMetadata.mediaType);if(e==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("Unsupported media type");var g=d("MAWThreadKeyUtils").stringThreadKeyToString(this.mediaDownloadMetadata.threadKey);yield b.runInTransaction(function(b){return c("LSIssueAttachmentRestoreTaskStoredProcedure")(c("LSFactory")(b),{backupEntFbid:(i||(i=d("I64"))).of_string(a.mediaDownloadMetadata.backupEntFbid),deliveryObjectId:a.mediaDownloadMetadata.deliveryObjectId,mediaType:e,messageId:a.mediaDownloadMetadata.messageId,productType:a.mediaDownloadMetadata.productType,serverThreadKey:g,sortOrder:i.of_float(a.mediaDownloadMetadata.sortOrder),source:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI),threadId:a.mediaDownloadMetadata.threadId})},"readwrite",void 0,void 0,f.id+":49")});function e(){return a.apply(this,arguments)}return e}();return e}(c("MebMIMediaDownloader"));g.MAWMIMediaDownloader=a}),98);
__d("EncryptedBackupsDYIMessageProcessingUtils",["EncryptedBackupsDYIMediaDownloadHandlers","EncryptedBackupsDYISingleton","IGDMIMediaDownloader","MAWMIMediaDownloader","MebWAMediaDownloader","Promise","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Failed to resign CDN URL: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Media CDN URL has expired and should be renewed"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Successfully downloaded media"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Failed to download media"]);l=function(){return a};return a}function a(a,b){return{isUnsent:!1,media:new Set(),reactions:[],senderName:m(a),text:"",timestamp:(a=b)!=null?a:0,type:""}}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton(),c="Unknown User";if(a!=null){b=b.getContactNameForContactId(a);b!=null&&(c=b)}return c}function c(a,c,e,f,g,m,n,o,p,q){var r=d("EncryptedBackupsDYISingleton").getSingleton(),s=r.getLogger(),t={author:d("WAJids").toMsgrUserJid(n),chat:d("WAJids").toMsgrUserJid(g),externalId:o},u={hash:p,isUrlRenewed:!1,mediaEntry:f,protocolMsgId:t,sortOrderMs:q};n={onDownloadError:function(){void s.ERROR(l(),u.hash);r.deletePlaintextHashFromAttachmentDownloadsInProgress(u.hash);return(h||(h=b("Promise"))).resolve()},onDownloadSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){void s.LOG(k(),u.hash);var b=a.mimeType;a=a.plaintext;yield d("EncryptedBackupsDYIMediaDownloadHandlers").DYIMediaDownloadHandler(u.hash,b,a,t)});function c(b){return a.apply(this,arguments)}return c}(),onUrlExpired:function(){void s.LOG(j(),u.hash);return(h||(h=b("Promise"))).resolve()}};var v=new(d("MebWAMediaDownloader").MebWAMediaDownloader)(u,n,a),w=f.serverMediaType;f=f.objectId;if(w!=null&&f!=null&&typeof q==="number"){c={backupEntFbid:c,deliveryObjectId:f,hash:p,mediaType:w,messageId:o,productType:e,sortOrder:q,threadId:g,threadKey:m};f={onResignCdnUrlFailure:function(a){void s.ERROR(i(),u.hash,a.message);r.deletePlaintextHashFromAttachmentDownloadsInProgress(u.hash);return(h||(h=b("Promise"))).resolve()},onResignCdnUrlSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){});function c(){return a.apply(this,arguments)}return c}()};p=e==="msgr"?new(d("MAWMIMediaDownloader").MAWMIMediaDownloader)(c,f):new(d("IGDMIMediaDownloader").IGDMIMediaDownloader)(c,f);v.setNextHandler(p);p.setNextHandler(new(d("MebWAMediaDownloader").MebWAMediaDownloader)(u,n,a))}void v.handle()}g.buildBaseDyiMessage=a;g.getSenderName=m;g.startMediaDownloadChain=c}),98);
__d("EncryptedBackupsDYIThreadsRestore",["EncryptedBackupsDYIGenerateThreadMetadata","EncryptedBackupsDYISingleton","FBLogger","I64","LSFactory","LSThreadsRangesQueryStoredProcedure","MAWThreadKeyUtils","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["mailbox is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI failed during thread restore with error ",". Exiting DYI"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Calling initial message range query for ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["No thread ID found for thread with threadKey ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Retrieved thread metadata for thread with threadKey ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Metadata generation complete"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found a total of "," contacts"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Contact sync complete"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found "," E2EE threads"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["E2EE DYI - starting thread restore"]);s=function(){return a};return a}a=function(){function a(a,b,e){this.$1=!1,this.$2=(i||(i=d("I64"))).zero,this.$3=i.zero,this.$6=function(){throw c("FBLogger")("labyrinth_web").mustfixThrow("fetchMoreMessages not initialised")},this.$7=function(){throw c("FBLogger")("labyrinth_web").mustfixThrow("threadsFilter not initialised")},this.$8=function(){throw c("FBLogger")("labyrinth_web").mustfixThrow("threadKeyGenerator not initialised")},this.$4=d("EncryptedBackupsDYISingleton").getSingleton(),this.$5=this.$4.getLogger(),this.$6=a,this.$7=b,this.$8=e}var e=a.prototype;e.abort=function(){this.$1=!1,this.resetState()};e.startDYI=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=d("EncryptedBackupsDYISingleton").getSingleton();try{if(this.$1){b.logDYIQPLPoint("dyi_already_in_progress");return}b.logDYIQPLPoint("thread_restore_start");void this.$5.LOG(s());this.resetState();this.$1=!0;b.logDYIQPLPoint("threads_fetch_start");var c=(yield this.$4.getDB());yield this.$9(c);var e=(yield this.$10(c));b.logDYIQPLPoint("threads_fetch_end",{"int":{thread_count:e.length}});if(e.length===0){var f;yield (f=this.$4)==null?void 0:f.exitDYIEarly(!0,e.length);b.logDYIQPLPoint("no_e2ee_threads");return this.resetState()}void this.$5.LOG(r(),e.length);f=e.map(function(a){return d("MAWThreadKeyUtils").stringThreadKeyFromThreadKey(a.threadKey)});yield this.$8(c);b.logDYIQPLPoint("contacts_sync_start");yield this.$11(c,new Set(f));yield d("EncryptedBackupsDYIGenerateThreadMetadata").EncryptedBackupsDYIGenerateThreadMetadata(f);e=(e=this.$4)==null?void 0:e.getContactNameMap().size;b.logDYIQPLPoint("contacts_sync_end",{"int":{contact_count:e}});void this.$5.LOG(q());e!=null&&void this.$5.LOG(p(),e);void this.$5.LOG(o());(e=this.$4)==null?void 0:e.getThreadMetadataMap().forEach(function(b,c){void a.$5.LOG(n(),c)});f.forEach(function(d){var e,f=b.getThreadIdForThreadKey(d);if(f==null){void a.$5.WARN(m(),d);return}void a.$5.LOG(l(),f);(e=a.$4)==null?void 0:e.addThreadKeyToThreadsRestoreInProgress(d);void a.$6(c,f)});this.resetState();b.logDYIQPLPoint("thread_restore_end")}catch(a){b.logDYIQPLPoint("thread_restore_failure");void this.$5.ERROR(k(),a);this.abort();yield (e=this.$4)==null?void 0:e.exitDYIEarly(!0)}});function c(){return a.apply(this,arguments)}return c}();e.resetState=function(){this.$1=!1,this.$2=(i||(i=d("I64"))).zero,this.$3=i.zero};e.$12=function(a,b,e){void a.runInTransaction(function(a){return c("LSThreadsRangesQueryStoredProcedure")(c("LSFactory")(a),{additionalPagesToFetch:(i||(i=d("I64"))).zero,isLoadingAfter:!1,isLoadingBefore:!0,maxLastActivityTimestampMs:i.max_int,maxThreadKey:i.max_int,minLastActivityTimestampMs:b,minThreadKey:e,parentThreadKey:i.zero,shouldSkipE2eeThreadsRanges:!1})},"readwrite",void 0,void 0,f.id+":197")};e.$9=function(a){var c=this;return new(h||(h=b("Promise")))(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,e){try{var f=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.inbox_threads_ranges).getKeyRange((i||(i=d("I64"))).of_int32(1))));if(f==null){c.$5.ERROR(j());e();return}if(f.hasMoreBefore){yield c.$13(a,b);c.$2=f.minThreadKey;c.$3=f.minLastActivityTimestampMs;c.$12(a,f.minLastActivityTimestampMs,f.minThreadKey);return}else{b();return}}catch(a){e(a)}});return function(a,b){return e.apply(this,arguments)}}())};e.$13=function(a,c){var e=this,f=d("ReQL").fromTableAscending(a.tables.inbox_threads_ranges,["hasMoreBefore","minThreadKey","minLastActivityTimestampMs"]).getKeyRange((i||(i=d("I64"))).of_int32(1)),g={contents:function(){}};g.contents=f.subscribe(function(b,f){if(f.operation==="put"){b=f.value;f=b.hasMoreBefore;var h=b.minLastActivityTimestampMs;b=b.minThreadKey;if(f){(!(i||(i=d("I64"))).equal(b,e.$2)||!(i||(i=d("I64"))).equal(h,e.$3))&&(e.$2=b,e.$3=h,e.$12(a,h,b));return}c();g.contents()}});return(h||(h=b("Promise"))).resolve()};e.$10=function(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.threads).filter(this.$7))};e.$11=function(a,c){var e=this;return new(h||(h=b("Promise")))(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,f){f=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.participants,["threadKey","contactId"]).filter(function(a){return a.threadKey!=null&&c.has(d("MAWThreadKeyUtils").stringThreadKeyFromThreadKey(a.threadKey))})));var g=new Set(f.map(function(a){return(i||(i=d("I64"))).to_string(a.contactId)})),h={contents:function(){}};h.contents=d("ReQL").fromTableAscending(a.tables.contacts,["id"]).subscribe(function(c,f){if(f.operation==="add"){c=f.value.id;g.has((i||(i=d("I64"))).to_string(c))&&(e.$14(a,g)&&(b(),h.contents()))}});f=e.$14(a,g);if(f){h.contents();b();return}});return function(a,b){return f.apply(this,arguments)}}())};e.$15=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.contacts)));return new Set(a.map(function(a){return(i||(i=d("I64"))).to_string(a.id)}))});function c(b){return a.apply(this,arguments)}return c}();e.$14=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=(yield this.$15(a));return b.size===0||Array.from(b).every(function(a){return c.has(a)})});function c(b,c){return a.apply(this,arguments)}return c}();return a}();g.EncryptedBackupsDYIThreadsRestoreBase=a}),98);
__d("IGDEncryptedBackupsDYIProcessProtobufs",["EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","FBLogger","IGDMediaUtils","InstamadilloTransportPayload.pb","MebWAMediaDownloader","MessageBackupSupplementalKeyGenerator","WAArmadilloBackupMessage.pb","WAHashUtils","WAMediaUtils","WAStanzaUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling protobuf processing for restored message batch for thread with thread key ",""]);h=function(){return a};return a}function i(a,b){if(a.text!=null){b.text=a.text;b.type="text";return{dyiOutputObject:b,success:!0}}else{c("FBLogger")("labyrinth_web").mustfix("Instamadillo DYI - Unable to find a valid text object in protobuf");return{dyiOutputObject:b,success:!1}}}function j(a,b){var c,d;if(a.avatarSticker!=null)d=a.avatarSticker.mediaTransport,c="Sticker";else if(a.gif!=null)d=a.gif.mediaTransport,c="Gif";else if(a.staticPhoto!=null)d=a.staticPhoto.mediaTransport,c="Image";else if(a.video!=null)d=a.video.mediaTransport,c="Video";else if(a.voice!=null)d=a.voice.mediaTransport,c="Ptt";else if(a.raven!=null){var e;if(((e=a.raven.content)==null?void 0:e.staticPhoto)!=null){d=(e=a.raven.content)==null?void 0:e.staticPhoto.mediaTransport;c="Image"}else if(((e=a.raven.content)==null?void 0:e.video)!=null){d=(e=a.raven.content)==null?void 0:e.video.mediaTransport;c="Video"}}b.type="media";return{mediaTransport:d,mediaType:c}}function k(a,b,e,f,g,h,i,j,k){if(b!=null&&a!=null){var l=b==null?void 0:b.fileSha256,m=b==null?void 0:b.objectId;if(l!=null&&m!=null&&i!=null&&j!=null){e.type="media";l=d("WAHashUtils").stringToPlaintextHash(l);e.media.add(l);d("WAMediaUtils").stringToDeliveryObjectId(m);if(!f.isAttachmentDownloadInProgressForPlaintextHash(l)&&!f.isAttachmentDownloadCompleteForPlaintextHash(l)){f.addPlaintextHashToAttachmentDownloadsInProgress(l);m=d("IGDMediaUtils").mediaTransportToDecodedMediaEntry(b,a);m!=null&&void d("EncryptedBackupsDYIMessageProcessingUtils").startMediaDownloadChain(d("MebWAMediaDownloader").MebWADownloadMediaFromWorker,"-1","igd",m,g,h,i,k,l,j)}return{dyiOutputObject:e,success:!0}}}c("FBLogger")("labyrinth_web").mustfix("Instamadillo DYI - Unable to parse media object and initiate attachment download");return{dyiOutputObject:e,success:!1}}function l(a,b,d,e,f,g,h,i){b.type="link";var l=a.contentRef,m=a.text;a=a.media;var n=!0;if(l!=null){var o=JSON.parse(l);o=o.target_url;o!=null&&(b.url=o)}m!=null&&(b.text=m);if(a!=null){o=j(a,b);var p=o.mediaTransport;o=o.mediaType;o=k(o,p,b,d,e,f,g,h,i);p=o.success;n=p}m==null&&a==null&&l==null&&c("FBLogger")("labyrinth_web").warn("Instamadillo DYI - Unable to find a valid url, text, or media in receiver fetch xma protobuf");return{dyiOutputObject:b,success:n}}function m(a,b){if(a.text!=null){b.text=a.text;b.type="link";return{dyiOutputObject:b,success:!0}}else{c("FBLogger")("labyrinth_web").mustfix("Instamadillo DYI - Unable to find retrieve link content from link protobuf");return{dyiOutputObject:b,success:!1}}}function n(a){a.type="like";a.text="heart_emoji";return{dyiOutputObject:a,success:!0}}function o(a,b,d,e,f,g,h,o){var p=a.content,q;if(p!=null)if(p.text!=null)q=i(p.text,b);else if(p.media!=null){a=j(p.media,b);var r=a.mediaTransport;a=a.mediaType;q=k(a,r,b,d,e,f,g,h,o)}else if(p.link!=null)q=m(p.link,b);else if(p.receiverFetchXma!=null)q=l(p.receiverFetchXma,b,d,e,f,g,h,o);else if(p.like!=null)q=n(b);else if(p.collection!=null){var s=!0;p.collection.media.forEach(function(i){i=j(i,b);var a=i.mediaTransport;i=i.mediaType;i=k(i,a,b,d,e,f,g,h,o);a=i.success;if(!a){c("FBLogger")("labyrinth_web").mustfix("Instamadillo DYI - Media download failed for attachment in collection message protobuf. Attempting to download a total of %d attachments in this collection protobuf",(i=p.collection)==null?void 0:i.media.length)}s=a&&s});q={dyiOutputObject:b,success:s}}(q!=null&&!q.success||q==null)&&c("FBLogger")("labyrinth_web").mustfix("Instamadillo DYI - Unable to successfully process add message protobuf for thread");return q}function p(a,b){a=a.content;if(a!=null){var e;if(((e=a.reaction)==null?void 0:e.emoji)!=null&&((e=a.reaction)==null?void 0:e.reactionStatus)!=null){return{actor:d("EncryptedBackupsDYIMessageProcessingUtils").getSenderName(b),reaction:((e=a.reaction)==null?void 0:e.emoji)||""}}}c("FBLogger")("labyrinth_web").warn("Instamadillo DYI - Unable to process supplemental protobuf reaction for thread");return null}function q(a){a=a.content;if(a!=null){var b;if(((b=a.editText)==null?void 0:b.newContent)!=null)return{editCount:a.editText.editCount,text:a.editText.newContent}}c("FBLogger")("labyrinth_web").warn("Instamadillo DYI - Unable to process supplemental protobuf edit for thread");return null}function r(a,b){if(b.length===0)return a;if(b.length===1)return b[0].text;b=b.filter(function(a){a=a.editCount;return a!=null});if(b.length>0){b=[].concat(b).sort(function(a,b){return b.editCount-a.editCount});return b[0].text}return a}function a(a,b,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();void g.LOG(h(),b);e.forEach(function(e){try{var g,h=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,e.toplevelProtobuf.decryptedProtobuf),i=d("decodeProtobuf").decodeProtobuf(d("InstamadilloTransportPayload.pb").TransportPayloadSpec,h.payload),j=d("WAStanzaUtils").toStanzaId(e.otid);g=(g=h.metadata)==null?void 0:g.senderId;h=(h=h.metadata)==null?void 0:h.timestampMs;var k=[],l=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage(g,h);if(i!=null&&i.add!=null&&h!=null){i=i.add;i=o(i,l,f,b,a,g,h,j);i!=null&&(l=i.dyiOutputObject)}for(g=e.supplementalProtobufs,h=Array.isArray(g),i=0,g=h?g:g[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){if(h){if(i>=g.length)break;e=g[i++]}else{i=g.next();if(i.done)break;e=i.value}e=e;var m=e[0];e=e[1];var n=d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAReaction(m),s=d("MessageBackupSupplementalKeyGenerator").isSupplementalProtobufAnEdit(m);if(!n&&!s)continue;e=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,e.decryptedProtobuf);e=d("decodeProtobuf").decodeProtobuf(d("InstamadilloTransportPayload.pb").TransportPayloadSpec,e.payload);m=d("MessageBackupSupplementalKeyGenerator").getSupplementalSenderId(m);if(n&&e.supplement!=null){n=p(e.supplement,m);n!=null&&l.reactions.push(n)}if(s&&e.supplement!=null){m=q(e.supplement);m!=null&&k.push(m)}}k.length>0&&(l.text=r(l.text,k));f.setMessagesByThreadKey(a,j,l)}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Instamadillo DYI: Failed to decode protobuf during DYI")}})}g.processEBProtobufForDYIInstamadillo=a}),98);
__d("LSIssueInstamadilloDYIRangeQueryTask",["LSArrayGetObjectAt","LSBase64Encode.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure] Unable to get the client state."),d[2]=c.createArray(),void 0!==void 0?d[10]=(d[2].push(void 0),d[2]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure","Unable to get the client state.",d[2],c.i64.cast([0,3]))},function(e){return d[3]=new c.Map(),d[3].set("error_code",c.i64.cast([0,9])),d[3].set("error_message",a[4]==null?"":a[4]),d[3].set("stored_procedure","issueInstamadilloDYIRangeQueryTask"),d[4]=new c.Map(),d[4].set("act_thread_id",c.i64.to_string(a[1])==null?"":c.i64.to_string(a[1])),d[4].set("source",a[6]),d[4].set("request_id",void 0),d[4].set("restore_operation_type",c.i64.cast([0,2])),d[5]=new c.Map(),d[5].set("restore_context",d[4]),d[5].set("failure",d[3]),d[6]=d[5].get("restore_context"),d[5],d[7]=d[6].get("act_thread_id"),d[6],d[8]=c.toJSON(d[5]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[7]].join(""),c.i64.cast([0,50047]),d[8],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[9]=a[0],a})},function(a){return d[0]=!1}]):(f=e.item,c.sequence([function(a){return d[9]=f.deviceId,d[8]=f.backupTenancy,d[7]=f.encryptionVersion,d[2]=void 0,c.i64.neq(d[2],void 0)?c.resolve(d[3]=d[2]):c.sequence([function(a){return d[10]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[11]=a[0],a})},function(a){return d[11]?d[20]=(d[10].push(c.i64.cast([0,0])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[12]=a[0],a})},function(a){return d[12]?d[20]=(d[10].push(c.i64.cast([0,2])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[20]=(d[10].push(c.i64.cast([0,3])),d[10]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[14]=a[0],a})},function(a){return d[14]?d[20]=(d[10].push(c.i64.cast([0,4])),d[10]):0,d[15]=c.createArray(),d[16]=c.i64.of_int32(d[10].length),c.i64.gt(d[16],c.i64.cast([0,0]))?c.loopAsync(d[16],function(a){return d[20]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[10],d[20]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(a){return d[23]=(d[15].push(d[21]),d[15])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[20]=c.createArray(),d[21]=c.i64.of_int32(d[15].length),c.i64.gt(d[21],c.i64.cast([0,0]))?c.loopAsync(d[21],function(a){return d[23]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[15],d[23]).then(function(a){return a=a,d[24]=a[0],d[25]=a[1],a})},function(a){return d[26]=(d[20].push(c.i64.to_string(d[24])),d[20])}])}):c.resolve()},function(a){return d[22]=d[20].join(","),d[17]=d[22]}])},function(a){return d[15].some(function(a){return c.i64.eq(d[7],a)})?d[18]=d[7]:d[18]=void 0,c.i64.neq(d[18],void 0)?d[19]=d[18]:d[19]=void 0,d[3]=d[19]}])},function(e){return c.i64.neq(d[3],void 0)?d[4]=d[3]:d[4]=c.i64.cast([0,0]),c.i64.neq(d[8],void 0)?d[5]=d[8]:d[5]=c.i64.cast([0,1]),c.i64.neq(d[9],void 0)?c.sequence([function(e){return c.i64.neq(a[1],void 0)?c.sequence([function(e){return d[10]=new c.Map(),d[10].set("act_thread_id",c.i64.to_string(a[1])),d[10].set("request_id",a[4]),d[10].set("source",a[6]),c.nativeOperation(b("LSBase64Encode.nop"),f.ocmfClientStateBlob).then(function(a){return a=a,d[11]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),f.mailboxRootKeyBlob).then(function(a){return a=a,d[12]=a[0],a})},function(a){return d[13]=new c.Map(),d[13].set("ocmf_client_state_blob",d[11]==null?"":d[11]),d[13].set("mailbox_root_key",d[12]==null?"":d[12]),d[14]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[26]=(d[14].push(a.epochId),d[14])})},function(a){return d[24]="Queried locally available epochs. Count: ",d[15]=c.i64.of_int32(d[14].length),d[25]=c.i64.to_string(d[15]),d[16]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[16],d[24],d[16],d[25]].join("")),c.resolve()},function(e){return d[17]=new c.Map(),d[17].set("device_id",d[9]),d[17].set("raw_tokens",d[13]),d[17].set("locally_available_epochs",d[14]),d[18]=new c.Map(),d[18].set("reference_timestamp",a[3]),d[18].set("direction",c.i64.cast([0,1])),d[18].set("server_thread_key",a[1]),d[18].set("device_context",d[17]),d[19]=new c.Map(),d[19].set("restore_context",d[10]),d[19].set("success",d[18]),d[20]=d[19].get("restore_context"),d[19],d[21]=d[20].get("act_thread_id"),d[20],d[22]=c.toJSON(d[19]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[21]].join(""),c.i64.cast([0,50047]),d[22],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[23]=a[0],a})}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure] server_thread_key is null."),d[10]=c.createArray(),void 0!==void 0?d[18]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure","server_thread_key is null.",d[10],c.i64.cast([0,3]))},function(e){return d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,9])),d[11].set("error_message",a[4]==null?"":a[4]),d[11].set("stored_procedure","issueInstamadilloDYIRangeQueryTask"),d[12]=new c.Map(),d[12].set("act_thread_id",c.i64.to_string(c.i64.cast([-1,4294967295]))==null?"":c.i64.to_string(c.i64.cast([-1,4294967295]))),d[12].set("source",a[6]),d[12].set("request_id",void 0),d[12].set("restore_operation_type",c.i64.cast([0,2])),d[13]=new c.Map(),d[13].set("restore_context",d[12]),d[13].set("failure",d[11]),d[14]=d[13].get("restore_context"),d[13],d[15]=d[14].get("act_thread_id"),d[14],d[16]=c.toJSON(d[13]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[15]].join(""),c.i64.cast([0,50047]),d[16],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],a})}])},function(a){return d[6]=!0}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure] Unable to get the client state."),d[10]=c.createArray(),void 0!==void 0?d[18]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure","Unable to get the client state.",d[10],c.i64.cast([0,3]))},function(e){return d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,9])),d[11].set("error_message",a[4]==null?"":a[4]),d[11].set("stored_procedure","issueInstamadilloDYIRangeQueryTask"),d[12]=new c.Map(),d[12].set("act_thread_id",c.i64.to_string(a[1])==null?"":c.i64.to_string(a[1])),d[12].set("source",a[6]),d[12].set("request_id",void 0),d[12].set("restore_operation_type",c.i64.cast([0,2])),d[13]=new c.Map(),d[13].set("restore_context",d[12]),d[13].set("failure",d[11]),d[14]=d[13].get("restore_context"),d[13],d[15]=d[14].get("act_thread_id"),d[14],d[16]=c.toJSON(d[13]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[15]].join(""),c.i64.cast([0,50047]),d[16],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[6]=!1}])},function(a){return d[0]=d[6]}]))})},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueInstamadilloDYIRangeQueryTaskStoredProcedure";e.exports=a}),null);
__d("LSIssueInstamadilloDYIRangeQueryTaskStoredProcedure",["LSIssueInstamadilloDYIRangeQueryTask","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.threadId;d[1]=b.serverThreadKey;d[2]=b.numMessages;d[3]=b.startSortKey;d[4]=b.requestId;d[5]=b.newerNumMessages;d[6]=b.source;return c("LSIssueInstamadilloDYIRangeQueryTask").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("IGDEncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYIHandleMessageRestore","I64","IGDEncryptedBackupsDYIProcessProtobufs","LSFactory","LSIntEnum","LSIssueInstamadilloDYIRangeQueryTaskStoredProcedure","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWReStoreDb","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(h||(h=d("I64"))).of_int32(c("justknobx")._("1796")),k=(i||(i=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").INSTAMADILLO_DYI),l=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").INSTAMADILLO_DYI),yield a.runInTransaction(function(a){return c("LSIssueInstamadilloDYIRangeQueryTaskStoredProcedure")(c("LSFactory")(a),{newerNumMessages:(h||(h=d("I64"))).zero,numMessages:j,serverThreadKey:h.of_string(e),source:k,startSortKey:b,threadId:e})},"readwrite",void 0,void 0,f.id+":40")});return function(b,c,d){return a.apply(this,arguments)}}();function a(a,b,c,d){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var g=(yield d("MAWReStoreDb").getDB(f.id+":60"));void d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(g,a,b,c,e,d("IGDEncryptedBackupsDYIProcessProtobufs").processEBProtobufForDYIInstamadillo,l)});return m.apply(this,arguments)}g.INSTAMADILLO_DYI_BATCH_SIZE=j;g.taskCreationSource=k;g.handleIGDMessageRangeQueryRestore=a}),98);
__d("IGDEncryptedBackupsDYIThreadsRestore",["EncryptedBackupsDYISingleton","EncryptedBackupsDYIThreadsRestore","I64","IGDEncryptedBackupsDYIHandleMessageRestore","IGDInstamadilloUtils","LSFactory","LSIssueInstamadilloDYIRangeQueryTaskStoredProcedure","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWThreadKeyUtils","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").INSTAMADILLO_DYI),yield a.runInTransaction(function(a){return c("LSIssueInstamadilloDYIRangeQueryTaskStoredProcedure")(c("LSFactory")(a),{newerNumMessages:(h||(h=d("I64"))).zero,numMessages:d("IGDEncryptedBackupsDYIHandleMessageRestore").INSTAMADILLO_DYI_BATCH_SIZE,serverThreadKey:h.of_string(b),source:d("IGDEncryptedBackupsDYIHandleMessageRestore").taskCreationSource,threadId:b})},"readwrite",void 0,void 0,f.id+":39")});return j.apply(this,arguments)}function k(a){return d("IGDInstamadilloUtils").isInstamadilloCutover(a)}function l(a){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("EncryptedBackupsDYISingleton").getSingleton();a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.threads).filter(k)));a.forEach(function(a){b.setThreadMapping(d("MAWThreadKeyUtils").stringThreadKeyFromThreadKey(a.threadKey),(h||(h=d("I64"))).to_string(a.threadKey))})});return m.apply(this,arguments)}var n=null;function a(){n==null&&(n=new(d("EncryptedBackupsDYIThreadsRestore").EncryptedBackupsDYIThreadsRestoreBase)(i,k,l));return n}g.getInstance=a}),98);
__d("IGDHandleInstamadilloDYIRangeQueryRestore",["IGDEncryptedBackupsDYIHandleMessageRestore"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){return d("IGDEncryptedBackupsDYIHandleMessageRestore").handleIGDMessageRangeQueryRestore(a,b,c,e)}g["default"]=a}),98);