;/*FB_PKG_DELIM*/

__d("LSDecryptMessageProtobufsStoredProcedure",["LSDecryptMessageProtobufs","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.encryptedMessagesWithProtobufs;d[1]=b.actThreadId;return c("LSDecryptMessageProtobufs").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("LSEncryptedBackupsMessagesRangeQueryDirection",[],(function(a,b,c,d,e,f){a=Object.freeze({BEFORE:1,AFTER:2});f["default"]=a}),66);
__d("MAWEncryptedBackupsMessageRangeMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="8109364935837857"}),null);
__d("MAWEncryptedBackupsMessageRangeMutation.graphql",["MAWEncryptedBackupsMessageRangeMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},e={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null};g=[{alias:null,args:[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"}],concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"xfb_restore_messages_from_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},d,e,f],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[g,d,e,f,h,i],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[g,d,e,f,h,i,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:[a,c],kind:"Fragment",metadata:null,name:"MAWEncryptedBackupsMessageRangeMutation",selections:g,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,a],kind:"Operation",name:"MAWEncryptedBackupsMessageRangeMutation",selections:g},params:{id:b("MAWEncryptedBackupsMessageRangeMutation_facebookRelayOperation"),metadata:{},name:"MAWEncryptedBackupsMessageRangeMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("MEBEncryptionVersion",[],(function(a,b,c,d,e,f){a=Object.freeze({UNKNOWN:0,ENCRYPTION_KDF_WITH_VERSION:2,ENCRYPTION_KDF_WITH_NULL_SALT:3,ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY:4,TEST_VERSION:99});f["default"]=a}),66);
__d("MAWEncryptedBackupsMessageRangeMutation",["I64","LSAuthorityLevel","LSDecryptMessageProtobufsStoredProcedure","LSDict","LSFactory","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEncryptedBackupsMessageRangeMutation.graphql","MEBEncryptionVersion","Promise","ReQL","WABase64","WAJids","WorkerRelayEnvironment","asyncToGeneratorRuntime","createWorkerMutation","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("MAWEncryptedBackupsMessageRangeMutation"),m=h!==void 0?h:h=b("MAWEncryptedBackupsMessageRangeMutation.graphql");function n(a,b){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield d("WorkerRelayEnvironment").createWorkerRelayEnvironment();var e=c("createWorkerMutation")(m);e=e[0];return e({app_id:b,restore_payload_string:a})});return o.apply(this,arguments)}function a(a,b,c,d,e,f){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,h,m,o){var p,q=(yield (p=d("ReQL")).firstAsync(p.fromTableAscending(e.tables.secure_encrypted_backups_client_state)));p=(yield p.toArrayAsync(p.fromTableAscending(e.tables.secure_encrypted_backups_epochs)));p=p.filter(function(a){return a.authorityLevel!==c("LSAuthorityLevel").AUTHORITATIVE}).map(function(a){return(k||(k=d("I64"))).to_float(a.epochId)});if(q==null)return(i||(i=b("Promise"))).reject("Client state is null");var r=q.deviceId,s=q.mailboxRootKeyBlob;q=q.ocmfClientStateBlob;if(r==null||s==null||q==null)return(i||(i=b("Promise"))).reject("mandatory params of client state are null");var t=d("MAWCurrentUser").getAppID(),u=0;t!=null&&(u=Number(t));t=d("WAJids").threadIdForChatJid(a);t=(yield n(JSON.stringify({restore_context:{act_thread_id:t,tam_thread_subtype:0},success:{device_context:{device_id:(k||(k=d("I64"))).to_float(r),locally_available_epochs:p,raw_tokens:{mailbox_root_key:d("WABase64").encodeB64(s),ocmf_client_state_blob:d("WABase64").encodeB64(q)}},direction:h,reference_timestamp:k.to_string(g),server_thread_key:d("WAJids").threadIdForChatJid(a)}}),u));var v=t==null?void 0:(r=t.xfb_restore_messages_from_backup)==null?void 0:r.backup_id;s=t==null?void 0:(p=t.xfb_restore_messages_from_backup)==null?void 0:p.message_range_info;if(s==null)return(i||(i=b("Promise"))).reject("messange range info is null");if(v==null)return(i||(i=b("Promise"))).reject("backup_id is null");var w=s.has_more_before,x=s.has_more_after,y=s.next_message_timestamp_ms_after,z=s.next_message_timestamp_ms_before;if(w==null||x==null||y==null||z==null)return(i||(i=b("Promise"))).reject("message range info is not complete");var A=(u=t==null?void 0:(q=t.xfb_restore_messages_from_backup)==null?void 0:(h=q.encrypted_messages)==null?void 0:h.map(function(a){var b,e,f,g,h,i;if(a==null)return;var j=a.otid;if(j==null)return;b=(b=a.echo_document)==null?void 0:b.echo_document_string;e=(e=a.echo_document)==null?void 0:e.epoch_anon_id;a=a.protobuf_stanzas;f=a==null?void 0:(f=a.top_level_protobuf)==null?void 0:f.encrypted_protobuf_stanza;g=a==null?void 0:(g=a.top_level_protobuf)==null?void 0:g.epoch_anon_id;h=a==null?void 0:(h=a.top_level_protobuf)==null?void 0:h.epoch_id;i=a==null?void 0:(i=a.top_level_protobuf)==null?void 0:i.protobuf_timestamp_ms;var l=a==null?void 0:a.supplemental_protobufs;if(b==null||e==null||f==null||g==null||h==null||i==null)return;if(a!=null){a=d("LSShape").ofRecord({backup_id:Number(v),encryption_version:c("MEBEncryptionVersion").UNKNOWN,epoch_anon_id:new TextEncoder().encode(e).buffer,value:b});e=d("LSShape").ofRecord({encrypted_protobuf:f,encryption_version:c("MEBEncryptionVersion").UNKNOWN,epoch_anon_id:new TextEncoder().encode(g).buffer,epoch_id:(k||(k=d("I64"))).of_string(h),protobuf_timestamp_ms:k.of_string(i)});var m=new(c("LSDict"))();l==null?void 0:l.forEach(function(a){var b=a==null?void 0:a.supplemental_key,e=a==null?void 0:a.encrypted_protobuf_stanza,f=a.epoch_anon_id,g=a==null?void 0:a.epoch_id,h=a==null?void 0:a.protobuf_timestamp_ms;if(e==null||f==null||g==null||h==null||b==null)return;m.set(b,d("LSShape").ofRecord({encrypted_protobuf:e,encryption_version:c("MEBEncryptionVersion").UNKNOWN,epoch_anon_id:new TextEncoder().encode(f).buffer,epoch_id:(k||(k=d("I64"))).of_string(g),protobuf_timestamp_ms:k.of_string(h),sk_ciphertext:a==null?void 0:a.sk_ciphertext}))});return d("LSShape").ofRecord({encrypted_echo_message:a,encrypted_protobufs:d("LSShape").ofRecord({supplemental_protobufs:m,toplevel_protobuf:e}),otid:j})}}).filter(Boolean))!=null?u:[],B=(yield e.runInTransaction(function(b){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(b),{actThreadId:d("WAJids").threadIdForChatJid(a),encryptedMessagesWithProtobufs:c("LSVec").ofArray(A)})},"readwrite",void 0,void 0,f.id+":306"));c("promiseDone")(l.load().then(function(b){return e.runInTransaction(function(e){return b(e,0,d("WAJids").threadIdForChatJid(a),(e=B[0])!=null?e:c("LSVec").ofArray([]),w,(k||(k=d("I64"))).of_string(z),x,k.of_string(y),!1,m,k.to_string(g),void 0,c("LSVec").ofArray([]),(j||(j=d("LSIntEnum"))).ofNumber((e=o)!=null?e:c("LSMEBTaskCreationSource").UNKNOWN))},"readwrite",void 0,void 0,f.id+":316")}))});return p.apply(this,arguments)}g.getMessagesFromBackup=a}),98);
__d("MWEncryptedBackupsIssueRangeQuery",["I64","LSAppendDataTraceAddonStoredProcedure","LSDataTraceCheckPoint","LSDataTraceType","LSEncryptedBackupsBackupTenancy","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSIssueMessageRangeQueryTaskStoredProcedure","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsMessageRangeMutation","MAWMainTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","WAJids","WATagsLogger","asyncToGeneratorRuntime","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Issuing message range query for chatJid: "," skipped. EB not enabled"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][","] Issuing message range query for thread: "," startSortKey: "," numMessages: ","} "]);l=function(){return a};return a}function a(a,e,g,m,n,o,p,q){if(c("gkx")("23914")){var r=q!=null?q:d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("MAWEncryptedBackupUtils").getBackupTenancy(e.tables).then(function(g){if(g!=null&&(i||(i=d("I64"))).equal(g,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION)))return c("gkx")("5976")?d("MAWEncryptedBackupsMessageRangeMutation").getMessagesFromBackup(a,e,m,(i||(i=d("I64"))).to_float(o)>0?c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER:c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE,r,p):e.runInTransaction(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield d("MAWMainTraceUtils").startTraceWithTxn(b,(i||(i=d("I64"))).of_float(Date.now()),r,(j||(j=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_RESTORE));yield c("LSAppendDataTraceAddonStoredProcedure")(c("LSFactory")(b),{checkPointId:j.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ISSUE_MESSAGE_RANGE_QUERY),dataTraceId:r,syncChannel:i.neg_one});d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",r]).LOG(l(),r,a,i.to_string(m),i.to_string(n));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(p,q);return c("LSIssueMessageRangeQueryTaskStoredProcedure")(c("LSFactory")(b),{isPointQuery:!1,newerNumMessages:o,numMessages:n,source:j.ofNumber((b=p)!=null?b:c("LSMEBTaskCreationSource").UNKNOWN),startSortKey:i.to_string(m),threadId:d("WAJids").threadIdForChatJid(a),traceId:r})});return function(a){return e.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":77");else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore"]).WARN(k(),a);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(r,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(h||(h=b("Promise"))).resolve()}}));return r}return null}g.runQuery=a}),98);